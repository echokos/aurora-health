<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        :root {
            /* Event colors - same in both themes */
            --event-daily: oklch(76% .15 163);
            --event-hourly: oklch(70% .15 240);
            --event-weekly: oklch(80% .15 85);
            --event-monthly: oklch(70% .15 350);
            --event-recurring: oklch(65% .15 300);
        }
        
        body {
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        }
        
        /* Event pill styling */
        .event-pill {
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            margin-bottom: 2px;
        }
        
        .event-pill:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .event-pill.daily {
            background: oklch(76% .15 163 / 0.2);
            color: var(--event-daily);
            border-left: 3px solid var(--event-daily);
        }
        .event-pill.hourly {
            background: oklch(70% .15 240 / 0.2);
            color: var(--event-hourly);
            border-left: 3px solid var(--event-hourly);
        }
        .event-pill.weekly {
            background: oklch(80% .15 85 / 0.2);
            color: var(--event-weekly);
            border-left: 3px solid var(--event-weekly);
        }
        .event-pill.monthly {
            background: oklch(70% .15 350 / 0.2);
            color: var(--event-monthly);
            border-left: 3px solid var(--event-monthly);
        }
        .event-pill.recurring {
            background: oklch(65% .15 300 / 0.2);
            color: var(--event-recurring);
            border-left: 3px solid var(--event-recurring);
        }
        
        /* Recurring badge styling */
        .recurring-badge {
            padding: 0.35rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            background: oklch(65% .15 300 / 0.15);
            color: var(--event-recurring);
            border: 1px solid oklch(65% .15 300 / 0.3);
        }
        .recurring-badge:hover {
            background: oklch(65% .15 300 / 0.25);
        }
        
        /* Calendar grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
        }
        
        .calendar-header-cell {
            padding: 0.75rem 0.25rem;
            text-align: center;
            background: oklch(var(--b2));
            border-bottom: 1px solid oklch(var(--b3));
        }
        
        .calendar-header-cell.today {
            background: oklch(var(--p) / 0.1);
        }
        
        .calendar-header-cell .day-name {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .calendar-header-cell .day-date {
            font-size: 0.75rem;
            opacity: 0.6;
        }
        
        .time-cell {
            padding: 0.5rem 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: right;
            color: oklch(var(--bc) / 0.5);
            background: oklch(var(--b2));
            border-right: 1px solid oklch(var(--b3));
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding-right: 0.5rem;
            padding-top: 0.5rem;
        }
        
        .day-cell {
            min-height: 70px;
            padding: 0.35rem;
            background: oklch(var(--b1));
            border-right: 1px solid oklch(var(--b3));
            border-bottom: 1px solid oklch(var(--b3));
        }
        
        .day-cell:last-child {
            border-right: none;
        }
        
        .day-cell.today {
            background: oklch(var(--p) / 0.05);
        }
        
        /* Timeline list view */
        .timeline-marker {
            position: relative;
            padding-left: 1rem;
        }
        
        .timeline-marker::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: oklch(var(--b3));
        }
        
        /* Mobile: hide week view, force list view */
        @media (max-width: 767px) {
            .week-view-only { display: none !important; }
            .list-view { display: block !important; }
        }
        
        /* Desktop: Alpine handles show/hide via x-show */
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <div x-data="cronCalendar()" x-init="init()" class="container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- Unified Header -->
        <header class="navbar bg-base-100 rounded-box shadow-sm mb-6">
            <div class="flex-1">
                <a href="/" class="btn btn-ghost text-lg font-semibold">Aurora Health</a>
            </div>
            <div class="flex-none gap-2">
                <!-- Navigation -->
                <ul class="menu menu-horizontal px-1 hidden sm:flex">
                    <li><a href="/" class="opacity-70 hover:opacity-100">Health Monitor</a></li>
                    <li><a href="/cron" class="font-medium">Cron Calendar</a></li>
                </ul>
                <!-- Mobile dropdown -->
                <div class="dropdown dropdown-end sm:hidden">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    </div>
                    <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a href="/">Health Monitor</a></li>
                        <li><a href="/cron">Cron Calendar</a></li>
                    </ul>
                </div>
                <!-- Theme Toggle -->
                <label class="swap swap-rotate btn btn-ghost btn-circle">
                    <input type="checkbox" class="theme-controller" value="light" @change="toggleTheme($event)" />
                    <!-- sun icon -->
                    <svg class="swap-off fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
                    <!-- moon icon -->
                    <svg class="swap-on fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
                </label>
            </div>
        </header>
        
        <!-- View Toggle (below header, hidden on mobile) -->
        <div class="flex items-center justify-end mb-4 week-view-only" x-show="view === 'week' || window.innerWidth >= 768">
            <div class="join">
                <button class="join-item btn btn-sm" :class="view === 'week' ? 'btn-primary' : 'btn-ghost'" @click="view = 'week'">Week</button>
                <button class="join-item btn btn-sm" :class="view === 'list' ? 'btn-primary' : 'btn-ghost'" @click="view = 'list'">List</button>
            </div>
        </div>
        
        <!-- Week Navigation (Week View Only) -->
        <div x-show="view === 'week'" class="flex items-center justify-between mb-4 week-view-only">
            <h2 class="text-lg font-semibold" x-text="weekRangeDisplay"></h2>
            <div class="flex items-center gap-2">
                <button class="btn btn-ghost btn-sm btn-square" @click="weekOffset--">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button class="btn btn-ghost btn-sm" @click="weekOffset = 0" :class="weekOffset === 0 ? 'btn-disabled opacity-50' : ''">Today</button>
                <button class="btn btn-ghost btn-sm btn-square" @click="weekOffset++">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- ==================== WEEK VIEW ==================== -->
        <div x-show="view === 'week'" class="week-view-only">
            
            <!-- Calendar Grid -->
            <div class="card bg-base-100 border border-base-300 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <div class="calendar-grid" style="min-width: 700px;">
                        
                        <!-- Header Row -->
                        <div class="calendar-header-cell"></div>
                        <template x-for="day in weekDays" :key="day.key">
                            <div class="calendar-header-cell" :class="day.isToday ? 'today' : ''">
                                <div class="day-name" x-text="day.name"></div>
                                <div class="day-date" x-text="day.dateNum"></div>
                            </div>
                        </template>
                        
                        <!-- Hour Rows -->
                        <template x-for="hour in displayHours" :key="hour">
                            <div style="display: contents">
                                <!-- Time Label -->
                                <div class="time-cell" x-text="formatHour(hour)"></div>
                                
                                <!-- Day Cells -->
                                <template x-for="day in weekDays" :key="'cell-' + day.key + '-' + hour">
                                    <div class="day-cell" :class="day.isToday ? 'today' : ''">
                                        <template x-for="event in getEventsForCell(day.dayOfWeek, hour, day.dateNum)" :key="event.id + '-' + day.key">
                                            <div 
                                                class="event-pill" 
                                                :class="getEventClass(event)"
                                                @click="showEventDetail(event)"
                                                x-text="truncateName(event.name)">
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                    </div>
                </div>
            </div>
            
            <!-- Recurring Jobs Section (High-Frequency) -->
            <div class="card bg-base-100 border border-base-300 shadow-sm mt-4" x-show="recurringEvents.length > 0">
                <div class="card-body p-4">
                    <h3 class="text-sm font-semibold text-base-content/70 mb-3">Frequent Jobs</h3>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="event in recurringEvents" :key="event.id">
                            <button 
                                class="recurring-badge"
                                @click="showEventDetail(event)">
                                <span x-text="event.name"></span>
                                <span class="opacity-60 ml-1" x-text="'· ' + formatFreqShort(event.schedule.frequency)"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- ==================== LIST VIEW ==================== -->
        <div x-show="view === 'list'" class="list-view">
            
            <!-- Date Header -->
            <h2 class="text-lg font-semibold mb-4" x-text="todayDisplay"></h2>
            
            <!-- Timeline -->
            <div class="space-y-6">
                <template x-for="timeGroup in timelineGroups" :key="timeGroup.hour">
                    <div>
                        <div class="text-xs font-medium text-base-content/50 mb-2" x-text="formatHour(timeGroup.hour)"></div>
                        <div class="timeline-marker space-y-2">
                            <template x-for="event in timeGroup.events" :key="event.id">
                                <div 
                                    class="card bg-base-100 border border-base-300 cursor-pointer hover:bg-base-200/50 transition-colors"
                                    @click="showEventDetail(event)">
                                    <div class="card-body p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-medium text-sm" x-text="event.name"></span>
                                                    <span 
                                                        x-show="event.schedule.frequency === 'weekly'" 
                                                        class="badge badge-xs badge-ghost"
                                                        x-text="event.schedule.day + 's only'">
                                                    </span>
                                                </div>
                                                <p class="text-xs text-base-content/60 mt-0.5" x-text="event.description || event.schedule.display"></p>
                                            </div>
                                            <span class="text-base-content/30">→</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Recurring Section (List View) -->
            <div class="mt-8" x-show="recurringEvents.length > 0">
                <div class="border-t border-dashed border-base-300 pt-6">
                    <h3 class="text-sm font-semibold text-base-content/70 mb-3">Recurring (Throughout the day)</h3>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="event in recurringEvents" :key="event.id">
                            <button 
                                class="recurring-badge"
                                @click="showEventDetail(event)">
                                <span x-text="event.name"></span>
                                <span class="opacity-60 ml-1" x-text="'· ' + formatFreqShort(event.schedule.frequency)"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Event Detail Modal -->
        <dialog id="event-modal" class="modal">
            <div class="modal-box max-w-md">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="document.getElementById('event-modal').close()">✕</button>
                
                <h3 class="font-bold text-lg pr-8" x-text="selectedEvent?.name || ''"></h3>
                
                <div class="mt-4 space-y-4">
                    
                    <!-- Info Table -->
                    <div class="bg-base-200 rounded-lg p-3 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Schedule</span>
                            <span class="font-medium" x-text="selectedEvent?.schedule?.display || ''"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Frequency</span>
                            <span x-text="formatFreq(selectedEvent?.schedule?.frequency)"></span>
                        </div>
                        <div class="flex justify-between" x-show="selectedEvent?.schedule?.day">
                            <span class="text-base-content/60">Day</span>
                            <span x-text="selectedEvent?.schedule?.day || ''"></span>
                        </div>
                    </div>
                    
                    <!-- Script & Log -->
                    <div class="bg-base-200 rounded-lg p-3 space-y-2 text-sm" x-show="selectedEvent?.script || selectedEvent?.logfile">
                        <div x-show="selectedEvent?.script">
                            <span class="text-base-content/60 text-xs">Script</span>
                            <p class="font-mono text-xs break-all mt-0.5" x-text="selectedEvent?.script || ''"></p>
                        </div>
                        <div x-show="selectedEvent?.logfile" class="pt-2 border-t border-base-300">
                            <span class="text-base-content/60 text-xs">Log File</span>
                            <p class="font-mono text-xs break-all mt-0.5" x-text="selectedEvent?.logfile || ''"></p>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div x-show="selectedEvent?.description" class="text-sm">
                        <span class="text-base-content/60 text-xs">Description</span>
                        <p class="mt-0.5" x-text="selectedEvent?.description || ''"></p>
                    </div>
                    
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
        
        <!-- Footer -->
        <div class="text-center text-base-content/30 text-xs mt-8">
            <span x-text="data.sources?.total || 0"></span> jobs · Updated <span x-text="formatTime(data.generated)"></span>
        </div>
        
    </div>
    
    <script>
        function cronCalendar() {
            return {
                data: { events: [], sources: {} },
                view: window.innerWidth >= 768 ? 'week' : 'list',
                selectedEvent: null,
                weekOffset: 0,
                
                async init() {
                    await this.fetchData();
                    setInterval(() => this.fetchData(), 60000);
                    
                    // Handle resize
                    window.addEventListener('resize', () => {
                        if (window.innerWidth < 768) this.view = 'list';
                    });
                },
                
                async fetchData() {
                    try {
                        const resp = await fetch('cron-events.json?t=' + Date.now());
                        this.data = await resp.json();
                    } catch (e) {
                        console.error('Failed to fetch cron data:', e);
                    }
                },
                
                // Get Monday of the target week
                getMonday(offset = 0) {
                    const today = new Date();
                    const day = today.getDay();
                    const diff = today.getDate() - day + (day === 0 ? -6 : 1) + (offset * 7);
                    return new Date(today.setDate(diff));
                },
                
                // Week range display: "February 10 - 16, 2026"
                get weekRangeDisplay() {
                    const monday = this.getMonday(this.weekOffset);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    
                    const monthA = monday.toLocaleDateString('en-US', { month: 'long' });
                    const monthB = sunday.toLocaleDateString('en-US', { month: 'long' });
                    const year = sunday.getFullYear();
                    
                    if (monthA === monthB) {
                        return `${monthA} ${monday.getDate()} - ${sunday.getDate()}, ${year}`;
                    } else {
                        return `${monthA} ${monday.getDate()} - ${monthB} ${sunday.getDate()}, ${year}`;
                    }
                },
                
                // Today display for list view
                get todayDisplay() {
                    const today = new Date();
                    return 'Today - ' + today.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                },
                
                // Week days array (Mon-Sun)
                get weekDays() {
                    const days = [];
                    const monday = this.getMonday(this.weekOffset);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(monday);
                        d.setDate(monday.getDate() + i);
                        d.setHours(0,0,0,0);
                        
                        days.push({
                            key: i,
                            name: dayNames[i],
                            dayOfWeek: i, // 0=Mon, 1=Tue, ..., 6=Sun
                            dateNum: d.getDate(),
                            isToday: d.getTime() === today.getTime()
                        });
                    }
                    return days;
                },
                
                // Hours to display (3am-7am when most jobs run)
                get displayHours() {
                    return [3, 4, 5, 6, 7];
                },
                
                // High frequency/recurring events (shown separately)
                get recurringEvents() {
                    return (this.data.events || []).filter(e => {
                        const freq = e.schedule?.frequency || '';
                        return freq.startsWith('every-') || freq === 'hourly';
                    });
                },
                
                // Non-recurring events for timeline
                get scheduledEvents() {
                    return (this.data.events || []).filter(e => {
                        const freq = e.schedule?.frequency || '';
                        return !freq.startsWith('every-') && freq !== 'hourly';
                    });
                },
                
                // Timeline groups for list view - filtered for TODAY
                get timelineGroups() {
                    const groups = {};
                    const today = new Date();
                    const todayDate = today.getDate();
                    // Convert JS day (0=Sun) to our format (0=Mon, 6=Sun)
                    const jsDay = today.getDay();
                    const todayDayOfWeek = jsDay === 0 ? 6 : jsDay - 1;
                    
                    const dayMap = {
                        'monday': 0, 'mon': 0,
                        'tuesday': 1, 'tue': 1,
                        'wednesday': 2, 'wed': 2,
                        'thursday': 3, 'thu': 3,
                        'friday': 4, 'fri': 4,
                        'saturday': 5, 'sat': 5,
                        'sunday': 6, 'sun': 6
                    };
                    
                    this.scheduledEvents.forEach(event => {
                        const time = event.schedule?.times?.[0];
                        if (!time || time === 'recurring') return;
                        
                        const match = time.match(/^(\d+):/);
                        if (!match) return;
                        
                        const freq = event.schedule?.frequency || '';
                        
                        // Weekly events: only show if today matches
                        if (freq === 'weekly') {
                            const eventDay = (event.schedule?.day || '').toLowerCase();
                            if (dayMap[eventDay] !== todayDayOfWeek) return;
                        }
                        
                        // Monthly events: only show on 1st of month
                        if (freq === 'monthly') {
                            if (todayDate !== 1) return;
                        }
                        
                        const hour = parseInt(match[1]);
                        if (!groups[hour]) {
                            groups[hour] = { hour, events: [] };
                        }
                        groups[hour].events.push(event);
                    });
                    
                    return Object.values(groups).sort((a, b) => a.hour - b.hour);
                },
                
                // Get events for a specific calendar cell
                // dayOfWeek: 0=Mon, 1=Tue, ..., 6=Sun
                // dateNum: day of month (1-31)
                getEventsForCell(dayOfWeek, hour, dateNum) {
                    return (this.data.events || []).filter(e => {
                        const freq = e.schedule?.frequency || '';
                        
                        // Skip high-frequency (shown in recurring section)
                        if (freq.startsWith('every-') || freq === 'hourly') return false;
                        
                        // Must have a time
                        const time = e.schedule?.times?.[0];
                        if (!time || time === 'recurring') return false;
                        
                        // Parse hour - handle both "04:00" and ":05" formats
                        let eventHour;
                        if (time.startsWith(':')) {
                            // Hourly format like ":05" - skip (handled in recurring)
                            return false;
                        }
                        const match = time.match(/^(\d+):/);
                        if (!match) return false;
                        eventHour = parseInt(match[1]);
                        if (eventHour !== hour) return false;
                        
                        // Daily: show every day
                        if (freq === 'daily') {
                            return true;
                        }
                        
                        // Weekly: check day matches
                        if (freq === 'weekly') {
                            const eventDay = (e.schedule?.day || '').toLowerCase();
                            const dayMap = {
                                'monday': 0, 'mon': 0,
                                'tuesday': 1, 'tue': 1,
                                'wednesday': 2, 'wed': 2,
                                'thursday': 3, 'thu': 3,
                                'friday': 4, 'fri': 4,
                                'saturday': 5, 'sat': 5,
                                'sunday': 6, 'sun': 6
                            };
                            return dayMap[eventDay] === dayOfWeek;
                        }
                        
                        // Monthly: only show on 1st of month
                        if (freq === 'monthly') {
                            return dateNum === 1;
                        }
                        
                        // Unknown frequency - show all days
                        return true;
                    });
                },
                
                getEventClass(event) {
                    const freq = event?.schedule?.frequency || '';
                    if (freq.startsWith('every-')) return 'recurring';
                    if (freq === 'hourly') return 'hourly';
                    if (freq === 'weekly') return 'weekly';
                    if (freq === 'monthly') return 'monthly';
                    return 'daily';
                },
                
                truncateName(name) {
                    if (!name) return '';
                    // Shorten common long names for the calendar cells
                    const shorts = {
                        'Nightly Memory Organization': 'Nightly Memory',
                        'Memory Compaction (Nightly)': 'Memory Compact',
                        'Monthly Index Generation': 'Monthly Index',
                        'Yearly Index Generation': 'Yearly Index',
                        'Wardrobe Selection': 'Wardrobe',
                        'OAuth Token Refresh': 'OAuth Refresh',
                        'mem0 Memory System': 'mem0 Verify'
                    };
                    return shorts[name] || name;
                },
                
                formatHour(hour) {
                    if (hour === 0) return '12 AM';
                    if (hour < 12) return hour + ' AM';
                    if (hour === 12) return '12 PM';
                    return (hour - 12) + ' PM';
                },
                
                formatTime(iso) {
                    if (!iso) return '';
                    const d = new Date(iso);
                    return d.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                },
                
                formatFreq(freq) {
                    const labels = {
                        'daily': 'Daily',
                        'hourly': 'Every hour',
                        'every-1-min': 'Every minute',
                        'every-5-min': 'Every 5 minutes',
                        'every-10-min': 'Every 10 minutes',
                        'every-15-min': 'Every 15 minutes',
                        'every-30-min': 'Every 30 minutes',
                        'weekly': 'Weekly',
                        'monthly': 'Monthly',
                        'unknown': 'Custom schedule'
                    };
                    return labels[freq] || freq || 'Unknown';
                },
                
                formatFreqShort(freq) {
                    const labels = {
                        'hourly': '1h',
                        'every-1-min': '1m',
                        'every-5-min': '5m',
                        'every-10-min': '10m',
                        'every-15-min': '15m',
                        'every-30-min': '30m'
                    };
                    return labels[freq] || freq || '';
                },
                
                showEventDetail(event) {
                    this.selectedEvent = event;
                    document.getElementById('event-modal').showModal();
                },
                
                toggleTheme(event) {
                    const theme = event.target.checked ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('aurora-theme', theme);
                }
            };
        }
        
        // Apply saved theme on load
        (function() {
            const saved = localStorage.getItem('aurora-theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
                const checkbox = document.querySelector('.theme-controller');
                if (checkbox) checkbox.checked = saved === 'light';
            }
        })();
    </script>
</body>
</html>
