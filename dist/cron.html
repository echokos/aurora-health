<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Cron Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        .freq-daily { border-left: 3px solid #22c55e; }
        .freq-hourly { border-left: 3px solid #3b82f6; }
        .freq-recurring { border-left: 3px solid #a855f7; }
        .freq-weekly { border-left: 3px solid #f59e0b; }
        .freq-monthly { border-left: 3px solid #ec4899; }
        
        .week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
        }
        .week-header {
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
            background: var(--fallback-b1,oklch(var(--b1)/1));
        }
        .week-hour {
            padding: 0.25rem;
            font-size: 0.75rem;
            text-align: right;
            background: var(--fallback-b1,oklch(var(--b1)/1));
            color: var(--fallback-bc,oklch(var(--bc)/0.6));
        }
        .week-cell {
            min-height: 2rem;
            padding: 0.25rem;
            background: var(--fallback-b1,oklch(var(--b1)/1));
            font-size: 0.7rem;
        }
        .week-event {
            padding: 2px 4px;
            border-radius: 2px;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="min-h-screen bg-base-300">
    <div x-data="cronDashboard()" x-init="init()" class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Top Navigation -->
        <div class="flex justify-between items-center mb-6">
            <a href="/" class="btn btn-ghost btn-sm">← Health Dashboard</a>
            <a href="https://dash.kos.plus" class="btn btn-ghost btn-sm">Main Dashboard →</a>
        </div>
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">Cron Schedule</h1>
            <p class="text-base-content/60" x-text="'Last updated: ' + formatTime(data.generated)"></p>
        </div>
        
        <!-- View Toggle (desktop only) -->
        <div class="hidden md:flex justify-center mb-6 gap-2">
            <button class="btn btn-sm" :class="view === 'list' ? 'btn-primary' : 'btn-ghost'" @click="view = 'list'">List</button>
            <button class="btn btn-sm" :class="view === 'week' ? 'btn-primary' : 'btn-ghost'" @click="view = 'week'">Week</button>
        </div>
        
        <!-- Legend -->
        <div class="flex flex-wrap gap-3 justify-center mb-6 text-sm">
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded"></span> Daily</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded"></span> Hourly</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-purple-500 rounded"></span> High Frequency</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-amber-500 rounded"></span> Weekly</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-pink-500 rounded"></span> Monthly</span>
        </div>
        
        <!-- List View -->
        <div x-show="view === 'list'" class="space-y-2">
            <div class="alert alert-info mb-4">
                <span>Showing all scheduled jobs. Each job runs on its specified schedule (daily, weekly, hourly, etc.)</span>
            </div>
            <template x-for="group in groupedByTime" :key="group.time">
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body p-4">
                        <h3 class="font-bold text-lg" x-text="group.time"></h3>
                        <div class="space-y-2 mt-2">
                            <template x-for="event in group.events" :key="event.id">
                                <div class="flex items-center justify-between py-2 px-3 rounded bg-base-200" :class="getFreqClass(event.schedule.frequency)">
                                    <div class="flex-1">
                                        <div x-text="event.name"></div>
                                        <div class="text-xs opacity-60 mt-1" x-text="event.schedule.display"></div>
                                    </div>
                                    <span class="badge badge-ghost text-xs" x-text="formatFrequency(event.schedule.frequency)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Week View -->
        <div x-show="view === 'week'" class="hidden md:block">
            <div class="card bg-base-100 shadow-lg overflow-x-auto">
                <div class="week-grid min-w-[600px]">
                    <!-- Header row -->
                    <div class="week-header"></div>
                    <template x-for="day in weekDays" :key="day.short">
                        <div class="week-header" :class="day.isToday ? 'text-primary' : ''">
                            <div x-text="day.short"></div>
                            <div class="text-sm opacity-60" x-text="day.date"></div>
                        </div>
                    </template>
                    
                    <!-- Hour rows -->
                    <template x-for="hour in hourSlots" :key="hour">
                        <template x-fragment>
                            <div class="week-hour" x-text="hour + ':00'"></div>
                            <template x-for="day in weekDays" :key="day.short + hour">
                                <div class="week-cell">
                                    <template x-for="event in getEventsForDayAndHour(day, hour)" :key="event.id">
                                        <div class="week-event" :class="getFreqClass(event.schedule.frequency).replace('freq-', 'bg-').replace('daily', 'green-500/20').replace('weekly', 'amber-500/20').replace('monthly', 'pink-500/20')" x-text="event.name"></div>
                                    </template>
                                </div>
                            </template>
                        </template>
                    </template>
                </div>
            </div>
            
            <!-- High frequency jobs (separate section) -->
            <div class="card bg-base-100 shadow-lg mt-4">
                <div class="card-body p-4">
                    <h3 class="font-bold">High Frequency Jobs</h3>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <template x-for="event in data.events?.filter(e => e.schedule.frequency?.includes('every')) || []" :key="event.id">
                            <span class="badge badge-outline freq-recurring" x-text="event.name + ' (' + event.schedule.display + ')'"></span>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center text-base-content/40 text-sm mt-8">
            <p>Auto-refreshes every 60 seconds</p>
            <p class="mt-1">
                <a href="/" class="link">Health Dashboard</a> ·
                <a href="https://dash.kos.plus" class="link">Main Dashboard</a>
            </p>
        </div>
    </div>
    
    <script>
        function cronDashboard() {
            return {
                data: { events: [] },
                view: 'list',
                
                async init() {
                    await this.fetchData();
                    setInterval(() => this.fetchData(), 60000);
                },
                
                async fetchData() {
                    try {
                        const resp = await fetch('cron-events.json?t=' + Date.now());
                        this.data = await resp.json();
                    } catch (e) {
                        console.error('Failed to fetch cron data:', e);
                    }
                },
                
                get groupedByTime() {
                    const groups = {};
                    const order = ['03:00', '03:30', '04:00', '05:00', '05:30', '06:00', 'Hourly', 'High Frequency'];
                    
                    for (const event of this.data.events || []) {
                        let key = 'Other';
                        const freq = event.schedule.frequency;
                        
                        if (freq === 'every-5-min' || freq === 'every-10-min' || freq === 'every-15-min') {
                            key = 'High Frequency';
                        } else if (freq === 'hourly') {
                            key = 'Hourly';
                        } else if (event.schedule.times && event.schedule.times[0]) {
                            key = event.schedule.times[0];
                        }
                        
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(event);
                    }
                    
                    // Sort by order array, then alphabetically for unlisted
                    return Object.entries(groups)
                        .sort((a, b) => {
                            const idxA = order.indexOf(a[0]);
                            const idxB = order.indexOf(b[0]);
                            if (idxA >= 0 && idxB >= 0) return idxA - idxB;
                            if (idxA >= 0) return -1;
                            if (idxB >= 0) return 1;
                            return a[0].localeCompare(b[0]);
                        })
                        .map(([time, events]) => ({ time, events }));
                },
                
                formatTime(iso) {
                    if (!iso) return 'Unknown';
                    const d = new Date(iso);
                    return d.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                },
                
                getFreqClass(freq) {
                    const classes = {
                        'daily': 'freq-daily',
                        'hourly': 'freq-hourly',
                        'every-5-min': 'freq-recurring',
                        'every-10-min': 'freq-recurring',
                        'every-15-min': 'freq-recurring',
                        'weekly': 'freq-weekly',
                        'monthly': 'freq-monthly'
                    };
                    return classes[freq] || '';
                },
                
                get weekDays() {
                    const days = [];
                    const today = new Date();
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay()); // Sunday
                    
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(startOfWeek);
                        d.setDate(startOfWeek.getDate() + i);
                        days.push({
                            short: d.toLocaleDateString('en-US', { weekday: 'short' }),
                            date: d.getDate(),
                            isToday: d.toDateString() === today.toDateString()
                        });
                    }
                    return days;
                },
                
                get hourSlots() {
                    // Only show hours 3-7 AM where most jobs run
                    return [3, 4, 5, 6, 7];
                },
                
                formatFrequency(freq) {
                    const labels = {
                        'daily': 'Daily',
                        'hourly': 'Hourly',
                        'every-5-min': 'Every 5min',
                        'every-10-min': 'Every 10min',
                        'every-15-min': 'Every 15min',
                        'weekly': 'Weekly',
                        'monthly': 'Monthly'
                    };
                    return labels[freq] || freq;
                },
                
                getEventsForDayAndHour(day, hour) {
                    return (this.data.events || []).filter(e => {
                        const time = e.schedule.times?.[0];
                        if (!time || time === 'recurring') return false;
                        
                        // Check if hour matches
                        const h = parseInt(time.split(':')[0]);
                        if (h !== hour) return false;
                        
                        // For daily/hourly jobs, show on all days
                        if (e.schedule.frequency === 'daily' || e.schedule.frequency === 'hourly') {
                            return true;
                        }
                        
                        // For weekly jobs, only show on matching day
                        if (e.schedule.frequency === 'weekly' && e.schedule.display) {
                            const dayName = e.schedule.display.toLowerCase();
                            return dayName.includes(day.short.toLowerCase());
                        }
                        
                        // For monthly jobs, only show on day 1
                        if (e.schedule.frequency === 'monthly') {
                            return day.date === 1;
                        }
                        
                        // Default: show on all days
                        return true;
                    });
                }
            };
        }
    </script>
</body>
</html>
